<!DOCTYPE html>
<html>
<head>
    <title>æŠ•èµ„ç»„åˆç®¡ç†ä¸­å¿ƒ</title>
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="stylesheet" href="/static/dashboard.css">
</head>
<body>
    <div class="container">
        <div class="dashboard-header">
            <div class="header-content">
                <div>
                    <h1>æŠ•èµ„ç»„åˆç®¡ç†ä¸­å¿ƒ</h1>
                    <div class="dashboard-subtitle">ç®¡ç†æ‚¨çš„æŠ•èµ„ç»„åˆã€è¿½è¸ªæŒä»“è¡¨ç°å¹¶ä¼˜åŒ–èµ„äº§é…ç½®</div>
                </div>
                <!-- ä¸ªäººä¸­å¿ƒ -->
                <div class="user-menu">
                    <button id="userMenuButton" class="user-menu-button">
                        <span class="user-icon">ğŸ‘¤</span>
                        <span class="user-name">ç”¨æˆ·</span>
                        <span class="dropdown-arrow">â–¼</span>
                    </button>
                    <div id="userDropdown" class="user-dropdown">
                        <a href="#" class="dropdown-item" onclick="showUserProfile()">ä¸ªäººèµ„æ–™</a>
                        <a href="#" class="dropdown-item logout-item" onclick="confirmLogout()">é€€å‡ºç™»å½•</a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- åˆ›å»ºç»„åˆè¡¨å• -->
        <div class="create-form">
            <h3>åˆ›å»ºæ–°ç»„åˆ</h3>
            <form action="/api/portfolio/create" method="post">
                <input type="hidden" name="user_id" value="{{ user_id }}">
                <input type="text" name="name" placeholder="ç»„åˆåç§°" required>
                <input type="text" name="description" placeholder="ç»„åˆæè¿°ï¼ˆå¯é€‰ï¼‰">
                <button type="submit">åˆ›å»ºç»„åˆ</button>
            </form>
        </div>
        
        <!-- æŠ•èµ„ç»„åˆæ ‡ç­¾é¡µ -->
        <div class="tabs">
            {% for p in portfolios %}
            <div class="tab-wrapper">
                <button class="tab" onclick="openTab(event, 'portfolio-{{ p.id }}')">
                    {{ p.name }}{% if p.description %}<span class="tab-desc">({{ p.description }})</span>{% endif %}
                </button>
                <button type="button" class="tab-close" onclick="confirmDeletePortfolioByTab(event, '{{ user_id|e }}', '{{ p.id|e }}')">&times;</button>
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ“Š</div>
                <h3>æš‚æ— æŠ•èµ„ç»„åˆ</h3>
                <p>ç‚¹å‡»ä¸Šæ–¹çš„è¡¨å•åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªæŠ•èµ„ç»„åˆ</p>
            </div>
            {% endfor %}
        </div>
        
        <!-- æ¯ä¸ªç»„åˆçš„å†…å®¹ -->
        {% for p in portfolios %}
        <div id="portfolio-{{ p.id }}" class="tab-content">
            <div class="portfolio-info">
                <div class="portfolio-stats">
                    <div class="stat-item">
                        <div class="stat-value">{{ p.items|length }}</div>
                        <div class="stat-label">æŒä»“æ•°é‡</div>
                    </div>
                    {% set total_cost = p.items|sum(attribute='quantity') * p.items|sum(attribute='cost') / p.items|length if p.items else 0 %}
                    <div class="stat-item">
                        <div class="stat-value">Â¥{{ "%.2f"|format(total_cost) }}</div>
                        <div class="stat-label">æ€»æˆæœ¬</div>
                    </div>
                </div>
            </div>
            

            
            <!-- æ·»åŠ æŒä»“è¡¨å• -->
            <div class="portfolio-items">
                <div class="add-item-form">
                    <h4>æ·»åŠ æŒä»“</h4>
                    <form action="/api/portfolio/{{ p.id }}/items/add" method="post">
                        <div class="form-group">
                            <input type="text" name="symbol" placeholder="åŸºé‡‘/è‚¡ç¥¨ä»£ç " required>
                            <input type="number" name="quantity" placeholder="æŒæœ‰æ•°é‡" step="0.01" required>
                            <input type="number" name="cost" placeholder="å•ä½æˆæœ¬" step="0.01" required>
                            <button type="submit">æ·»åŠ </button>
                        </div>
                    </form>
                </div>
                
                <!-- æŒä»“æ˜ç»†è¡¨æ ¼ -->
                <h4>æŒä»“æ˜ç»†</h4>
                {% if p.items %}
                <table>
                    <thead>
                        <tr>
                            <th>ä»£ç </th>
                            <th>æ•°é‡</th>
                            <th>å•ä½æˆæœ¬</th>
                            <th>æ€»æˆæœ¬</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in p.items %}
                        <tr>
                            <td>{{ item.symbol }}</td>
                            <td>{{ item.quantity }}</td>
                            <td>Â¥{{ "%.2f"|format(item.cost) }}</td>
                            <td>Â¥{{ "%.2f"|format(item.quantity * item.cost) }}</td>
                            <td>
                                <form style="display:inline" action="/api/portfolio/{{ p.id }}/items/delete" method="post">
                                    <input type="hidden" name="item_id" value="{{ item.id }}">
                                    <button type="button" class="delete-btn" onclick="confirmDeleteItem(this.form)">åˆ é™¤</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“ˆ</div>
                    <h3>æš‚æ— æŒä»“</h3>
                    <p>ä½¿ç”¨ä¸Šæ–¹è¡¨å•æ·»åŠ æ‚¨çš„ç¬¬ä¸€æ”¯è‚¡ç¥¨æˆ–åŸºé‡‘</p>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    
    <script>
        // æ ‡ç­¾é¡µåˆ‡æ¢åŠŸèƒ½
        function openTab(evt, tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾å†…å®¹
            var tabContent = document.getElementsByClassName("tab-content");
            for (var i = 0; i < tabContent.length; i++) {
                tabContent[i].classList.remove("active");
            }
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„activeç±»
            var tabs = document.getElementsByClassName("tab");
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove("active");
            }
            
            // æ˜¾ç¤ºå½“å‰æ ‡ç­¾å†…å®¹å¹¶è®¾ç½®å½“å‰æ ‡ç­¾ä¸ºactive
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.classList.add("active");
        }
        
        // åˆ é™¤ç»„åˆç¡®è®¤å‡½æ•°
        function confirmDeletePortfolio(form) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¯¥ç»„åˆå—ï¼Ÿè¿™å°†åŒæ—¶åˆ é™¤æ‰€æœ‰æŒä»“æ˜ç»†ã€‚')) {
                console.log('ç¡®è®¤åˆ é™¤ç»„åˆï¼Œæäº¤è¡¨å•:', form.action);
                form.submit();
            } else {
                console.log('å–æ¶ˆåˆ é™¤ç»„åˆ');
            }
        }
        
        // é€šè¿‡æ ‡ç­¾é¡µå…³é—­æŒ‰é’®åˆ é™¤ç»„åˆ
        function confirmDeletePortfolioByTab(event, userId, portfolioId) {
            event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢è§¦å‘æ ‡ç­¾é¡µç‚¹å‡»
            if (confirm('ç¡®å®šè¦åˆ é™¤è¯¥ç»„åˆå—ï¼Ÿè¿™å°†åŒæ—¶åˆ é™¤æ‰€æœ‰æŒä»“æ˜ç»†ã€‚')) {
                console.log('ç¡®è®¤åˆ é™¤ç»„åˆï¼Œç”¨æˆ·ID:', userId, 'ç»„åˆID:', portfolioId);
                // åˆ›å»ºè¡¨å•å¹¶æäº¤
                var form = document.createElement('form');
                form.method = 'post';
                form.action = '/api/portfolio/delete';
                
                var userIdInput = document.createElement('input');
                userIdInput.type = 'hidden';
                userIdInput.name = 'user_id';
                userIdInput.value = userId;
                form.appendChild(userIdInput);
                
                var portfolioIdInput = document.createElement('input');
                portfolioIdInput.type = 'hidden';
                portfolioIdInput.name = 'portfolio_id';
                portfolioIdInput.value = portfolioId;
                form.appendChild(portfolioIdInput);
                
                document.body.appendChild(form);
                form.submit();
            }
        }
        
        // åˆ é™¤æŒä»“ç¡®è®¤å‡½æ•°
        function confirmDeleteItem(form) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¯¥æŒä»“å—ï¼Ÿ')) {
                console.log('ç¡®è®¤åˆ é™¤æŒä»“ï¼Œæäº¤è¡¨å•:', form.action);
                form.submit();
            } else {
                console.log('å–æ¶ˆåˆ é™¤æŒä»“');
            }
        }
        
        // é»˜è®¤æ‰“å¼€ç¬¬ä¸€ä¸ªæ ‡ç­¾
        document.addEventListener("DOMContentLoaded", function() {
            var firstTab = document.querySelector(".tab");
            if (firstTab) {
                firstTab.click();
            }
            
            // æ·»åŠ è°ƒè¯•ä»£ç æ£€æŸ¥åˆ é™¤æŒ‰é’®å’Œè¡¨å•
            console.log("DOM åŠ è½½å®Œæˆï¼Œå¼€å§‹æ£€æŸ¥åˆ é™¤åŠŸèƒ½");
            
            // æ£€æŸ¥åˆ é™¤ç»„åˆæŒ‰é’®
            var deletePortfolioBtns = document.querySelectorAll(".delete-portfolio");
            console.log("æ‰¾åˆ°", deletePortfolioBtns.length, "ä¸ªåˆ é™¤ç»„åˆæŒ‰é’®");
            
            // æ£€æŸ¥åˆ é™¤æŒä»“æŒ‰é’®
            var deleteItemBtns = document.querySelectorAll(".delete-btn");
            console.log("æ‰¾åˆ°", deleteItemBtns.length, "ä¸ªåˆ é™¤æŒä»“æŒ‰é’®");
            
            // åˆå§‹åŒ–ä¸ªäººä¸­å¿ƒèœå•
            initUserMenu();
        });
        
        // åˆå§‹åŒ–ä¸ªäººä¸­å¿ƒèœå•
        function initUserMenu() {
            const userMenuButton = document.getElementById('userMenuButton');
            const userDropdown = document.getElementById('userDropdown');
            
            if (userMenuButton && userDropdown) {
                // ç‚¹å‡»ç”¨æˆ·èœå•æŒ‰é’®åˆ‡æ¢ä¸‹æ‹‰èœå•æ˜¾ç¤ºçŠ¶æ€
                userMenuButton.addEventListener('click', function() {
                    userDropdown.classList.toggle('show');
                    userMenuButton.classList.toggle('active');
                });
                
                // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰èœå•
                document.addEventListener('click', function(event) {
                    if (!userMenuButton.contains(event.target) && !userDropdown.contains(event.target)) {
                        userDropdown.classList.remove('show');
                        userMenuButton.classList.remove('active');
                    }
                });
                
                // é˜²æ­¢ç‚¹å‡»ä¸‹æ‹‰èœå•å†…çš„é¡¹ç›®å…³é—­èœå•
                userDropdown.addEventListener('click', function(event) {
                    event.stopPropagation();
                });
            }
        }
        
        // æ˜¾ç¤ºä¸ªäººèµ„æ–™ï¼ˆæ¨¡æ‹ŸåŠŸèƒ½ï¼‰
        function showUserProfile() {
            alert('ä¸ªäººèµ„æ–™åŠŸèƒ½å°†åœ¨åç»­ç‰ˆæœ¬ä¸­å®ç°');
        }
        
        // ç¡®è®¤é€€å‡ºç™»å½•
        function confirmLogout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                // åˆ›å»ºé€€å‡ºç™»å½•è¡¨å•å¹¶æäº¤
                const form = document.createElement('form');
                form.method = 'post';
                form.action = '/api/auth/logout';
                
                document.body.appendChild(form);
                form.submit();
            }
        }
    </script>
</body>
</html>
